{
  "version": 3,
  "sources": ["../../../app/scripts/utils/helpers.ts", "../../../app/scripts/pages/backtest/AppBacktest.ts", "../../../app/scripts/pages/backtest/index.ts"],
  "sourcesContent": ["export function cloneTemplate<T extends HTMLElement>(\n    template: HTMLTemplateElement\n) {\n    const content = template.content.firstElementChild;\n    if (!content) {\n        throw new Error(\"Template content is empty\");\n    }\n    return content.cloneNode(true) as T;\n}\n\nexport function updateElementsTextWithData<T>(data: T, container: HTMLElement) {\n    Object.entries(data as Record<string, unknown>).forEach(([key, value]) => {\n        const element = container.querySelector(`.${key}`) as HTMLElement;\n        element.textContent = String(value);\n    });\n}\n\nexport function roundToDecimalPlace(amount: number, point: number) {\n    const decimalPoint = Math.pow(10, point);\n    return Math.round(amount * decimalPoint) / decimalPoint;\n}\n", "import {\n    cloneTemplate,\n    updateElementsTextWithData,\n} from \"@app/scripts/utils/helpers\";\n\nexport default class AppBacktest extends HTMLElement {\n    private data: ICandles[];\n    private market: string;\n\n    constructor() {\n        super();\n        this.data = [];\n        this.market = \"KRW-BTC\";\n\n        this.onChangeMarket = this.onChangeMarket.bind(this);\n    }\n\n    connectedCallback() {\n        this.loadAndRender();\n\n        this.querySelector(\"select\")?.addEventListener(\n            \"change\",\n            this.onChangeMarket\n        );\n    }\n\n    private onChangeMarket(event: Event) {\n        const target = event.target as HTMLInputElement;\n        this.market = target.value;\n        this.loadAndRender();\n    }\n\n    private async loadAndRender() {\n        const originData = await this.getCandles();\n        this.calculateMovingAverage(originData); // 5\uC77C \uC774\uB3D9\uD3C9\uADE0\uC120\n        this.enrichingData();\n        this.render();\n    }\n\n    private async getCandles() {\n        const searchParams = new URLSearchParams({\n            market: this.market,\n            count: \"1000\",\n        });\n\n        const response = await fetch(`/fetchCandles?${searchParams}`);\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n        return await response.json();\n    }\n\n    private calculateMovingAverage(originData: ICandles[], period = 5) {\n        this.data = originData.slice(period - 1).map((aData, index) => {\n            // console.log(\"!!!!!\", index, aData);\n\n            let sum = 0;\n\n            for (let i = 0; i < period; i++) {\n                // console.log(index + i, originData[index + i]);\n                sum += originData[index + i].trade_price;\n            }\n\n            return {\n                ...aData,\n                moving_average_5: sum / period,\n            };\n        });\n    }\n\n    private enrichingData() {\n        // condition\n        this.data = this.data.map((aData) => {\n            if (!aData.moving_average_5) return aData;\n\n            return {\n                ...aData,\n                condition: aData.moving_average_5 > aData.trade_price,\n            };\n        });\n\n        // action\n        this.data = this.data.map((aData, index) => {\n            let action = \"\";\n            if (index === 0) {\n                if (aData.condition) action = \"Buy\";\n                else if (!aData.condition) action = \"\";\n            } else {\n                const prevCondition = this.data[index - 1].condition;\n                if (prevCondition && aData.condition) {\n                    action = \"Hold\";\n                } else if (prevCondition && !aData.condition) {\n                    action = \"Sell\";\n                } else if (!prevCondition && aData.condition) {\n                    action = \"Buy\";\n                } else if (!prevCondition && !aData.condition) {\n                    action = \"none\";\n                }\n            }\n\n            return {\n                ...aData,\n                action,\n            };\n        });\n\n        // order\n        const investmentAmount = 200000;\n        let orderPrice = 0;\n        let profit = 0;\n        let totalProfit = 0;\n        let total = 0;\n        this.data = this.data.map((aData) => {\n            switch (aData.action) {\n                case \"Buy\":\n                    orderPrice = aData.trade_price;\n                    profit = 0;\n                    total = total || investmentAmount;\n\n                    // console.log(\"Buy\", aData.candle_date_time_kst, orderPrice);\n\n                    break;\n                case \"Sell\":\n                    const rate = (aData.trade_price - orderPrice) / orderPrice;\n                    profit = rate * total || investmentAmount;\n                    totalProfit += profit;\n                    total = investmentAmount + totalProfit;\n\n                    // console.log(\n                    //     \"Sell\",\n                    //     aData.candle_date_time_kst,\n                    //     \"orderPrice:\",\n                    //     orderPrice,\n                    //     \"trade_price: \",\n                    //     aData.trade_price,\n                    //     aData.trade_price - orderPrice\n                    // );\n\n                    break;\n                case \"none\":\n                    profit = 0;\n                    break;\n            }\n\n            return {\n                ...aData,\n                profit,\n                totalProfit,\n                total,\n            };\n        });\n    }\n\n    private async render() {\n        const tableElement = this.querySelector(\"tbody\") as HTMLElement;\n        const summaryElement = this.querySelector(\".summary\") as HTMLElement;\n\n        tableElement.innerHTML = \"\";\n        const fragment = new DocumentFragment();\n\n        this.data\n            .map((aData: ICandles) => this.createItem(aData))\n            .forEach((cloned: HTMLElement) => fragment.appendChild(cloned));\n\n        tableElement?.appendChild(fragment);\n\n        const lastProfit = this.data[this.data.length - 1].totalProfit;\n        if (!lastProfit) return;\n        const totalRate = Math.round((lastProfit / 200000) * 100);\n        summaryElement.textContent = `${\n            this.market\n        } | ${totalRate}% | ${Math.round(lastProfit).toLocaleString()}`;\n    }\n\n    private createItem(aData: ICandles) {\n        const tpElement = document.querySelector(\n            \"#tp-item\"\n        ) as HTMLTemplateElement;\n        tpElement;\n\n        const cloned = cloneTemplate<HTMLElement>(tpElement);\n        if (!aData.moving_average_5) return cloned;\n\n        const parseData = {\n            ...aData,\n            candle_date_time_kst: aData.candle_date_time_kst.replace(\"T\", \" \"),\n            opening_price: aData.opening_price.toLocaleString(),\n            trade_price: aData.trade_price.toLocaleString(),\n            moving_average_5:\n                aData.moving_average_5 &&\n                aData.moving_average_5.toLocaleString(),\n            profit: aData.profit && Math.round(aData.profit).toLocaleString(),\n            totalProfit:\n                aData.totalProfit &&\n                Math.round(aData.totalProfit).toLocaleString(),\n            total: aData.total && Math.round(aData.total).toLocaleString(),\n        };\n\n        updateElementsTextWithData(parseData, cloned);\n\n        return cloned;\n    }\n}\n", "import AppBacktest from \"./AppBacktest\";\n\ncustomElements.define(\"app-backtest\", AppBacktest);\n"],
  "mappings": "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",
  "names": []
}
